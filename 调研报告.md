# Layer2

layer2层链下扩容方案调研
摘要
基于区块链的去中心化加密货币近年来得到了广泛的关注和部署，然而在区块链和加密货币世界中，事务处理扩展是一个难以解决的问题。它们目前表现出高延迟，并且不能处理与传统金融业系统相当的交易量。链下（Layer2）扩容是建立在（Layer1）区块链之上的一组技术或系统，继承了第一层的安全属性，并提供了比Layer1更大的事务处理能力(吞吐量)、更低的事务费用(操作成本)和更快的事务确认。我们将现有的链下扩容系方案进行多方面研究并提供了协议的各方面特性的比较。发现其未解决的问题，指明未来的研究工作方向。
一 研究背景
目前，ethereum 大约每秒处理15个事务，而 Visa 每秒处理大约45,000个事务。2017年的Cryptokitties 或和当今火热得Defi应用程序非常受欢迎，它们“减慢”了网络运行速度，提高了油价（Gas）。如果我们将块的大小增加一倍(即块的气体限制) 来提高网络吞吐能力，这将意味着每个节点处理每个块的工作量大致增加一倍。那么需要节点做更多的工作意味着功能较弱的计算机(如消费设备)可能会退出网络，而且在功能强大的节点操作者中挖掘变得更加集中。分片 (Sharding)技术 是以太坊Layer1的扩容方案。在eth2.0中，分片意味着将整个系统的存储和计算分割为分片，并独立处理各分片，然后根据需求组合结果，这对于扩展性来说是巨大的提升。但是这种分片扩容实施还需要一段时间。
那么链下（Layer2）则是近期比较理想的扩容方案如：支付和状态通道[1]、侧链[2]、Plasma[3]和Rollups[4]，链下（Layer2）解决方案的思路是：把计算、交易等业务处理拿到主链( layer1 )之外来执行，只在主链上反映最终的结果，中间过程不在主链做记录，它可以提供比 L1多50倍到1000倍的吞吐量。
二 解决方案
2.1 侧链
2.1.1 侧链的结构
侧链是与以太坊兼容的独立区块链，它们采用自己的共识模型来帮助主链有效地处理交易。侧链是分布式账本，它们独立运行并与以太坊主网具有并行容量。侧链网络中的节点负责确认和处理交易，将交易写入区块并维护整个网络的共识。由于和以太坊没有太大的关联，所以他的共识并不是继承于以太坊，并且自己负责自己的安全。


2.1.2 侧链的特点
1. 侧链通常包含替代的验证器选择和共识机制，以提供更快的交易时间。侧链负责其自身的安全性和共识过程。这可以进行创新和优化，并为用户提供增加交易吞吐量和更高速度/更低成本交易的机会，所以侧链使用各种验证器选择方法来实现这些目标，同时保持安全性。较小的验证者集更容易受到基于合谋的攻击，因此必须采取强有力的措施来鼓励诚实的验证并阻止恶意行为。
（1）权限证明：预先为协议选择了验证器，这些验证其就是负责签署交易并维护一致账本的网络节点。一个例子就是POA网络。POA使用“权威机构回合”共识，在此过程中，选定的验证者轮流签署交易并封锁交易。POA模型提高了可伸缩性（5秒的块时间，低廉的交易费用），同时又降低了分散程度（预先选择了验证器，并且协议设置了有限的验证器）。
（2）权益证明：根据验证者对协议的承诺金额选择一组验证者。拥有更多股份的节点更有可能被选作验证者。使用委派的桩号证明，用户可以向节点添加额外的桩号，以增加该节点成为验证者的可能性。xDai链就是一个例子，其中向协议中提交更多STAKE量（xDai治理令牌，由验证者候选者和委托者共同押注）的节点对动态验证者集的选择概率更高。一旦选定，激励措施将促进诚实的验证。
2.应用程序的交易可能更适合侧链采用。例子包括DAO投票，少量现金转移，加密艺术和NFT，社区货币，小型交易以及许多其他用例，这些用例可能不需要与高价值金融交易相同的安全保证。
2.2 支付通道
2.2.1 支付通道
支付通道是一种链下扩展解决方案，用于在以太坊区块链上执行符合ERC20的令牌转移。它是以太坊的比特币闪电网络版本，可实现近乎即时，低费用，可扩展且保护隐私的付款。支付通道是状态通道技术的一种实现。支付渠道允许两个参与者之间进行几乎无限的双向转移，只要其转移的总和不超过所存放的代币。这些传输可以立即执行，无需实际的区块链本身参与，除了最初的一次性链上创建和最终关闭通道外。支付通道允许参与者之间进行令牌的安全传输，而无需达成全球共识。这是通过使用数字签名和哈希锁定的转移，称作为余额证明来实现的，该转移由先前设置的链上存款完全抵押。

数字签名可确保任何一方都不能退出其中包含的任何价值转移，只要至少一名参与者决定将其呈现给区块链即可。由于除了两个参与者之外，

2.2.2 支付通道交易流程
双方创建渠道后，参与者可以自由地来回进行转账。余额证明包含发送给参与者的所有支付通道转移的最终总和，直到某个特定点为止，并由发送者进行数字签名。由于每个频道都有两个参与者，因此它总是保留其中两个参与者。来回进行转账，从而改变了参与者之间的余额。
在双方交易的最后，当一方决定在区块链上结清余额以要求或支付其未偿余额时，他们可以随时通过向智能合约出示其选择的余额证明来关闭渠道。另一位参与者-未选择关闭渠道的参与者-现在必须出示自己的余额证明，或者如果他们没有收到任何转让，则什么也不做。双方提交了余额证明后，他们现在可以提取其存款。提款可能由任何人触发，包括两个参与者以外的地址。如果第二个参与者未能及时提供其余额证明，则假定另一个参与者未收到任何转账，则余额将根据结束参与者的证明进行分配。当然在双方推出的时候，有可能存在争执，解决争执还是通过余额证明来验证哪一方参与者是做错了，并且对欺诈的一方给予惩罚，例如扣留欺诈一方在创建支付通道是所支付的押金。
2.2.3 支付通道优缺点
支付通道的优点主要是(1) 无论用户群的大小如何，当前大多数区块链的容量都被限制为固定或半固定的上限。与之形成鲜明对比的是，支付通道的容量与用户数量成线性比例增长，从而形成了高效且面向未来的分散式传输网络。(2)  支付通道转账也是即时的，从某种意义上说，一旦您收到支付通道转账，转移的价值现在属于您了(3)支付通道适合于双方进行多次的小额转账，因为只有在创建的时候需要成本，通道里的交易无论金额的大小几乎无需成本。
支付通道的主要缺点就是支付通道要求您的某些代币在支付渠道的有效期内被锁定在智能合约中。同样，由于网络中的每个参与者可能会同时打开多个通道，因此预计支付的通道押金会相对较小，从而难以在通道网络上转移大量代币。并且不适合于双方少量次数的交易。

2.3 状态通道
状态通道是支付通道的一般形式，在区块链上执行的任何类型的状态更改操作。区块链状态的一部分通过多重签名或某种智能合约被锁定，因此一组特定的参与者必须彼此完全同意才能对其进行更新。参与者更新状态彼此之间通过构建并签署该交易可能会被提交给主链，而是仅仅保存现在最新的状态。最后，参与者将状态提交回区块链，参与者双方同意推出并且在无欺诈的情况下区块链将关闭状态通道并再次解锁状态。
链下状态通道分为三个阶段：（1）打开，（2）链下修改和（3）关闭。要创建一个状态通道，需要隔离一部分区块链状态并将其锁定在链上。这部分称为状态存款，以资产表示。存款由所有参与者创建和锁定，通过发送链上交易来进行。
为了修改状态保证金，需要所有参与者的同意。已签名的消息在状态通道参与者之间直接交换。每个链下状态都附加到版本号和所有参与者的签名上，新的链下状态的创建取决于状态通道参与者的响应能力。因此，如果参与者是离线或无反应的，则无法更新状态，则需要关闭状态通道。
关闭状态通道需要将最终状态发布在区块链上。通常，预先确定的时间延迟使状态通道的所有参与者都有机会在区块链上接受最终状态之前提交具有更高版本号的链下状态。这为参与者提供了一定程度的完整性保证，即使用正确的最终态来关闭通道并拆分状态存款。
状态通道具备以下两种属性：
高速性：一旦打开状态通道，就可以非常快地达成一小部分参与者之间的协议，交易速度取决于参与者交换链下消息的响应能力和他们的网络连接。
即时性：对于链上tx，用户需要等待确认，然后才能认为tx完成。在状态通道中，参与者可以提交由所有参与者签名的最新状态，以立即关闭并最终确定通道状态。如有争议，底层区块链可数据的提供完整性。


2.4 Plasma
      2017年8月11日，Vitalik Buterin和Joseph Poon发表了一篇《Plasma: Scalable Autonomous Smart Contracts》的论文，提出了一种以太坊新颖的layer2层可扩展扩容技术——Plasma。像状态通道一样，Plasma是一种进行链下交易的技术，同时依赖底层的以太坊区块链来保证其安全性。但是，Plasma把想法带入到一个新的方向，它允许创建连接到主以太坊区块链的子区块链。Plasma的目标是在子链级别执行许多复杂的操作，以数千名用户运行整个应用程序，而与以太坊主链的交互最少，从而实现以太坊layer2层扩容。
       Plasma是一系列是智能合约，通过智能合约的强制执行来确保用户在一个合约状态中持有资金进行交易；是一种实现区块链扩容计算的方式，现阶段主要为以太坊layer2层扩容方案的一种探索形式，尚未落地实现；还是一个激励，和强制智能合约执行的框架，用户可以通过自身业务需求来创建Plasma链，如私有链，去中心化交易所，社交网络，小额支付通道等不同应用场景，从而实现可扩展性。Plasma由五个核心部分构成，激励层，MapReduce框架，共识机制，位图UTXO提交结构和退出机制。因此使得Plasma框架提高了成本和网络清算效率，兼容树结构同时重组状态转换为可扩展的形式，尽可能降低退出费用，在数据不可用或者其它拜占庭行为时可以退出。
       Plasma由五个核心部分构成，激励层，MapReduce框架，共识机制，位图UTXO提交结构和退出机制。因此使得plasma框架提高了成本和网络清算效率，兼容树结构同时重组状态转换为可扩展的形式，尽可能降低退出费用，在数据不可用或者其它拜占庭行为时可以退出。

2.4.1 Plasma的结构 
Plasma以树状结构来组织区块链，树中的每个节点，都代表一个唯一的区块链，这个区块链连接到它的父节点，所有这些区块链都被安排到一个巨大的层次结构中。如图Alice提交1ETH，就会一层一层地向下流动到主链。Plasma树状结构也类似于一个法院系统，每一级节点都向下一级父节点汇报，主链也就是最高级别的人民法院，因此主链可以对每一个Plasma链进行仲裁，Plasma链需要定期向主链汇报。 

Plasma使用树状结构有什么好处？ 如图，当红色区块Plasma链产生叛变时，它的子区块可以选择红色区块相邻的相同层的区块作为父节点（父链），进行一个批量迁移，过一段时间后，仍然可以正常地向主链提交信息，绕过叛变区块。因此，Plasma使用树状结构显著的好处是可以最大化区块的可用性。 

2.4.2 Plasma中的MapReduce框架
由于Plasma链使用树状结构，使得可以使用MapReduce框架进行高扩展计算。
如图右侧虚线是从父节点传递信息到子节点，父链向子链通过数据分发工作，子链提交工作证明。右侧虚线是节点完成计算后，向主链返回信息。返回信息以字典表的形式存储，最终会返回一个全局的字典到主链。先切分再聚合，MapReduce框架计算效率非常高，创造了在大规模情况下强制计算执行的可能，只需要一个区块头提交到主链但却可涵盖大量的数据和工作。除非需要发布某个区块是无效数据，其它情况下仅需周期性的提交很小的数据量到主链。

使用MapReduce框架还有一个好处是，从主链提取数据效率提高。如图，如果用户想提取右上角区块数据，它不需要遍历所有节点，不需要强制执行灰色的无关部分，而仅需关注和目标区块相关的链（最右边蓝色部分）即可。使用MapReduce框架使得人们只需要关注影响到自己提交的链，提升了可扩展性。

2.4.3 Plasma的欺诈证明
Plasma区块链是一个在区块链中的链，这个系统由押金的欺诈证明驱动强制执行。欺诈证明是Plasma创建的一种机制，可以防止欺诈，除非退出主链，任何人（包括用户自己）都可以向根合同发布欺诈证明，以试图证明区块生产者被骗了。欺诈证明是Plasma创建的一种机制，可以防止欺诈，除非退出主链，任何人（包括用户自己）都可以向根合同发布欺诈证明，以试图证明区块生产者被骗了。简单来说，可以通过欺诈证明来判断Plasma链有没有存在一些错误的，不正当的行为，如果这些行为确实存在，那么我们不但能够成功取回自己的资产，还能获得之前Plasma链存入的部分或全部押金。
Plasma区块链没有向主链公开自身链的内容，而是将区块的头哈希提交到主链，当出现需要欺诈证明的时候，然后块将回滚，区块的创建者将会受到惩罚。

如下图，在第 4 个区块中的交易被篡改，由于 Alice 本地保存有 Plasma 链中所有的区块数据，因此她可以向主链提交一个含有欺诈证明的交易。如果证明生效，那么主链将状态从4号区块回滚到3号区块，一切恢复正常。Plasmas 链中的参与者也可以随时提交资产证明，返回到主链。在某些设置的时间以后，区块将确定下来，且不能再提交欺诈证明。

2.4.4 Plasma链中的存款和取款
来自主链的存款将直接发送给主合约，合约有责任跟踪当前的提交状态，使用欺诈证明来惩罚无效的提交，以及执行取款。
Plasma是基于UTXO模型的，存款的方式比较简单，如Alice有一个1ETH的账户，将资金存入Plasma链中，会以代币的方式存在。

取款方式主要有两种，简单取款和快速取款，具体如下所示：


特别地，当用户有取款请求的时候，需要等待一段“争议期”，在这段时间需要经受住各方提交的欺诈证明的考验，只有被证明不存在“欺诈”行为时，才能继续进行下一步。
快速取款则需要引入一个中间人，节省了“争议期”的时间，但需要给中间人支付一定的手续费。
2.4.5 Plasma的局限性
Plasma的局限性主要有以下两点：
1. 数据可用性差
因为Plasma区块链仅将批量交易的整体哈希值发布到 Layer 1 上，而不是每一笔交易均发布到底层公链，所以具体的交易数据不存在 Layer 1 上，用户需要自己存储具体的交易数据，因此数据可用性差。
2. 用户体验差 
为了避免恶意攻击，Plasma 在设计挑战期的机制的时候，用户需要定期上线网络，监视和验证plasma链上的交易，否则可能错过而遭受不必要的损失。除此之外，由于使用了欺诈证明机制，所有的退出只能在挑战期结束后处理，用户退出期较长，一般为一到两周，从而用户体验较差。
2.5 rollup
Plasma 和状态通道方案都是 “完全的” layer 2 方案，因为它们将数据和计算都转移到链下（即自己的二层系统中）。然而，数据可得性的基本博弈论原理意味着这样的系统不可能安全地实现所有应用。Plasma 和状态通道通过明确资产对象和所有者之间的关系来解决这个问题，但这使它们无法完全通用。Rollup 则与前两者不同，是一种具有 “混合性质” 的二层方案。Rollup 将计算（和完整的状态存储）转移到链下，但在链上保存了每笔交易的部分数据信息。为了提高效率，Rollup 使用了一系列花哨的压缩技巧，并尽可能地用计算替代数据。其结果是，这个系统的可扩展性仍然受限于底层区块链的数据带宽，但在此基础上实现的扩容倍数非常可观：在以太坊主链执行一笔 ERC-20 代币的转账大约消耗 45000 gas，但在 Rollup 中，每笔交易仅需要在主链上存储 16 字节数据，消耗的 gas 小于 300。
- 下图为以太坊主链的交易结构和最初提议版rollup合约的交易结构对比表格

Rollup方案的核心思想就是把多笔交易汇合起来，然后我们只需要在链上进行一次交易，就相当于验证执行了多笔交易。Rollup会在链下执行交易计算，完整的状态也存储在链下，而rollup会把交易的部分数据放在链上。因为交易的数据放在了链上，所以任何人无论在什么时候都能够从链上获取到交易数据，然后可以使用这些数据来验证状态转换的正确性。
Rollup会把交易进行压缩处理，上面这张图可以看到以太坊和rollup合约的交易结构对比，可以看到rollup的交易结构，把账户的地址压缩了，签名和一些不必要字段的也去掉了，就是为了尽可能的压缩交易的大小，然后rollup把所有交易汇总起来，放在了calldata上（calldata就是以太坊交易中存储数据参数的一个只读区域）。这样设计，就是为了尽可能的减少gas的消耗量，尽可能处理更多的交易。
- rollup方案图：

- rollup工作原理：
在主链上有一个智能合约，存有一个状态根 —— 表征 Rollup 状态的 Merkle 根。（状态内容包括 Rollup 中的账户余额，合约代码等）。


任何人（也可能是经过选举的）都可以在主链上对该智能合约发起一个批处理事务（transaction），这个批处理是对一批 Rollup 内部事务的高度压缩，还包括旧的状态根和新的状态根（在旧状态根基础上执行批处理交易之后生成的新状态根）。主链合约会检验旧的状态根与新的状态根是否匹配（即新的状态根是否可以由这一批交易集触发状态转换生成）。如果检验通过，主链上的旧状态根会更新为新状态根。

为了支持存款（将资产从主链的其他地方存入 Rollup 合约）和取款（解除 Rollup 合约对自己资产的控制，使之返回到链上其他地方），批处理中的事务的输入或输出可以是 Rollup “外部”（即主链其他地方）的状态。如果批处理中有交易的输入来自 Rollup 之外，那么这个批处理操作会将主链其他地方的资产转移至 Rollup 合约中。如果批处理中有交易的输出来自 Rollup 之外，那么这个批处理会触发智能合约中的取款操作，将资产从 Rollup 取回主链。
整个过程就这么简单！ 不过还有一个细节。如何知道批处理执行完成之后的状态根是正确的？ 如果有人可以提交一个伪造的状态根，而不产生任何后果，他们就可以把所有的资产转移给自己。这个问题很关键，因为这个问题有两种截然不同的解决办法，从而形成了两种类型的 Rollup。
2.5.1 zk rollup
ZkRollup就是基于零知识证明的二层扩容方案(layer2)， ZkRollup方案起源于18年下半年，由Barry Whitehat和Vitalik先后提出。Rollup顾名思义有“卷起”和“汇总”的意思，将大量的交易“卷起/汇总”打包成一个交易，ZkRollup的原理一句话就可以讲清楚：链下进行复杂的计算和证明的生成，链上进行证明的校验并存储部分数据保证数据可用性。ZkRollup数据可用性可以让任何人都能根据链上存储的交易数据，还原出账户的全局状态，从而消除由于数据可用性带来的安全风险（这里的数据可用性对比Plasma，Plasma之所以不能称为主流的扩容方案，在于Plasma的数据并没有提交到链上，所以在Plasma上退出一笔资产的周期会长达一周左右（争议期），如果在争议期间没有人提交欺诈证明，那么资产才可以安全退出到主链）。
工作原理：ZkRollup在链下利用Merkle Tree存储账户状态，由Operator收集用户的交易，交易收集完成后Operator会执行每个交易（校验余额，校验nonce，校验签名，执行状态转换），当交易执行完成后会产生一个新的Merkle Tree Root，为了证明链下状态转移是正确的，Operator会在交易执行完成后生成一个零知识证明的proof。
下图表示Operator工作过程，黄色的表示用户发送的交易，绿色的表示Operator中维护的Merkle Tree，Operator执行交易后本地的Merkle Tree Root会由pre state root转换成post state root，图中蓝色的表示Operator生成证明账户状态转移有效的零知识证明。

Operator把pre state root，post state root，交易数据和proof证明提交至链上合约，合约校验proof通过后会将来新的状态写入到链上，合约不需要单独校验每笔交易的合法性，只需要校验proof是否有效，降低了链上gas消耗，其中交易数据是存储在较便宜的位置CALLDATA上。链下每一次的状态转变都需要提供零知识证明，由主链上的合约进行验证，只有验证通过才能更改状态。即每一次状态转变都严格依赖密码学证明。
ZkRollup生成的证明大小（很小），验证时间（很快基本上是常数），不会随着交易数量的增长而变大，所以ZkRollup可以极大地提高TPS。影响ZkRollup链上性能的只有链上CALLDATA存储数据的成本,随着以太坊 Istanbul升级，CALLDATA使用成本降为原来的1/4，ZkRollup的性能则获得4倍提升，TPS可达到近2000左右。

上链的数据中pre state root，post state root与proof基本上是不会随着交易增长变化的，只有上图中黄色交易部分会随着交易增长变大，所以为了能在一个区块链中容纳更多的交易，需要对上链的交易进行压缩。ZkRollup使用Merkle Tree来记录地址，这样地址就可以表示成Merkle Tree的索引值，地址数据的大小就从原本的20 Bytes减少到3 Bytes，在以太坊上金额用32个字节256位的大整型来表示，这里压缩到6个字节，货币最小单位从wei变成Mwei = 10^6 wei，手续费压缩到1个字节，nonce压缩到2个字节，nonce的范围0~65535，也就是说一个账户最多可以发送65535笔交易，交易的签名直接删除了，不出现交易中，因为每笔交易的合法性在链下都通过零知识证明的电路约束校验过了。


2.5.2 Optimistic rollup
增强比特币可扩展性的最早举措之一是侧链。侧链是与父链共同运行的区块链，但具备不同的特点：出块时间更短、区块大小更大、智能合约的表达性更强等。然而，普通的侧链有个致命的缺点：如果一条侧链上的绝大多数矿工/验证者都是不诚实的，用户资金就会被盗。
2019 年 6 月，《最小可行合并共识》首次阐述了Optimistic rollup这一技术。从那时起，以太坊社区就开始大力支持 ORU，将其作为以太坊式智能合约执行的可扩展性方案。
- 工作方式：

optimistic rollup 的运作方式如下：任何人都可以在无需许可地提交一个侧链区块，将整个区块作为有待验证（即有待默克尔化）的调用数据（calldata）发布到链上，并交纳保证金。一个新的侧链区块只能链接到侧链的末端，由链上合约进行追踪（从最简化的角度看，该合约就像在运行一个侧链的轻客户端，存储着侧链区块头的哈希值）。一段较长的时间过后（这是一个系统参数，但需要足够长，例如一至两周），侧链区块会被确定下来，之后就会退还保证金。从侧链中取款回到主链上的操作要在侧链上发起，只需提供对一个已确定的侧链区块的非交互式包含证明（non-interactive inclusion proof）即可。如果一个侧链区块是无效的，且还没有得到最终确认，只要提交一个非交互式错误性证明，回滚这条侧链的末端，这个区块连同其之后的区块都会成为孤块。保证金会被销毁一半，另一半则奖励给提供错误性证明的人。这就实现了一条信任最小化的双向资金桥梁。
- 合并共识：
optimistic rollup 最突出的一个特点是合并共识（merged consensus）。合并共识是一种可在链上验证的共识协议（除此之外还有真正的区块验证，它是通过隐式的错误性证明来完成的）。但什么是去中心化共识协议呢？
去中心化共识协议包含以下几个相互独立的功能：
- 分叉选择规则（如何在两条都遵守了共识规则而形成的链之间选择出一条链）
- 区块有效性函数（状态转换函数）
- 领导者选举算法（通过该算法选举出一位领导者来生成新的区块，链接到区块链的末端，从而增加区块链的高度，或者说增加其长度）
- 抗女巫机制（工作量证明、权益证明等）
上述功能保障了区块链的经济 安全性 ：操纵历史是要付出代价的。（注意：为了简单起见，这里忽略了一些事实，例如，一些去中心化共识协议是无领导者的）。
在 optimistic rollup 方案中，侧链是不会出现分叉的，因此不需要分叉选择规则。区块有效性是在链下计算的，而且可以在链上用错误性证明来证明其不正确性。剩下还有领导者选举和抗女巫攻击的问题需要解决。
John Adler[5]所提出的规范提议采用 “先到先得” 机制，即在任一高度上，延长侧链长度的首笔交易会被采纳。领导者选举是隐式的，而且事后才会见出分晓，而抗女巫攻击是通过主链实现的（即，交易费和 区块大小/Gas 上限）。如此简单的领导者选举规则为何能起到作用？因为以太坊区块链已经提供了安全性。只有出现以下三种情况之时，才能将侧链上的某个区块变成孤块：1）该区块是无效的；2）该区块的某个祖先区块是无效的；3）以太坊区块链发生重组。因此，有效的区块也具备与以太坊同等程度的确定性和安全性！因此，我们不需要复杂的领导者选举算法，或是成本高昂的抗女巫攻击机制来保障安全性。侧链无需付出额外的成本即可获得安全性，因此我们可以极大地简化系统参数的设置。
optimistic rollup 虽然与延迟状态执行（delayed state execution）和影子链（shadow chain）等提议有诸多类似之处，但是一大关键的区别在于合并共识的概念。optimistic rollup 的共识协议是完全在链上的智能合约之内运行的；因此，它不会影响到主链的共识规则，也不需要得到其支持。相较之下，延迟状态执行和影子链实行的是链上自动状态转换，需要得到主链共识协议和协议内奖惩机制的明确支持。
- 可持续扩容：
现在我们已经明白 optimistic rollup 是如何通过合并共识实现免许可性及其背后的原因了，那么它是如何实现可持续扩容的呢？
有一个很实用的解决方案，可以通过减缓状态增长的速度来解决这一问题。那就是使用区块链作为数据可用性层。这种模式最初是由 zk rollup 推广使用的：将侧链交易数据作为调用数据(calldata)发布到主链上，然后使用有效性证明或错误性证明来确保该数据的正确性。结果证明，存储历史数据的成本比存储状态要低得多（低几个 数量级 ）。之后，可以通过主链来确保数据可用性，追踪 rollup 链的区块头，处理存取款，并验证 有效性证明/错误性证明，这些都不需要大量使用状态。通过减缓状态增长，扩容就可以实现长期可持续性。Vitalik 之前写过一篇很好的文章，总结了如何将链上数据可用性运用到 zk rollup 和 optimistic rollup 上。
- 非交互型错误性证明：
对于 optimistic rollup 来说，非交互型错误性证明非常重要。为什么？
非交互型错误性证明之所以如此重要，是因为要避免 Plasma Cash 存在的缺陷之一，即，针对无效历史的交互型退出挑战机制。这种交互型多步骤挑战机制导致 Plasma Cash 对链拥堵攻击的抵御能力较低。所谓的链拥堵攻击指的是攻击者为了窃取 Plasma 合约内的全部资金，向主链发送大量 “退出” 交易（不过，Plasma Cash 对这些攻击抵御能力比 Plasma M(ore)VP 更高）。只需要一个非交互型错误性证明就可以将（单条侧链上）任意数量的无效 optimistic rollup 区块变成孤块，使系统更能抵御链拥堵攻击。注：由于 optimistic rollup 使用了错误性证明，如果主链不具备抗审查性的话，依然存在资金遭窃的风险。
在 optimistic rollup 中，提款也是通过非交互型的方式处理的：先是在侧链上发起提款，然后针对主链上一个已得到最终确定的区块生成非交互型包含证明，再利用这个证明来完成提款。然而，这就要求侧链具有免许可性，因此需要的是合并共识，而非一个类似于 Plasma 的运营方。
相比交互型验证游戏来说，非交互型错误性证明更有优势。交互型验证游戏所需的时间比较长。鉴于 optimistic rollup 是不会产生分叉的，攻击者可以生成一个无效的区块，利用验证游戏造成侧链停摆，从而对系统发动 DoS 攻击。有了非交互型错误性证明，就可以立即证实欺诈行为（然而，需要注意的一点是，错误性证明的证明范围比交互型验证游戏要窄——至于这种局限性是否真的对区块链应用有很大影响，这点尚待讨论）。
- 构建Optimistic Rollup的团队
Fuel —— 聚焦于稳定币支付的 UTXO 数据模型。
Plasma Group —— 在 OVM （Optimistic Virtue Machine）环境下的通用型类 EVM 智能合约，已经在 Devcon 5 上宣布与 Uniswap 达成合作。
Arbitrum —— 使用了交互型验证游戏机制的通用型智能合约。
IDEX —— 为 IDEX 交易所构建了 “优化型 Optimistic Rollup”
SKALE —— 使用 BLS Signature 聚合的 Optimistic rollup 。
NutBerry —— 使用了交互型验证游戏机制的通用型类 EVM 智能合约。
Interstate Network —— 使用错误性证明的通用型类 EVM 智能合约。

三 总结
Layer2扩容解决方案一直处于开发阶段，有很多的应用即将上线用。在Layer2上构建应用程序可获得比直接在Layer1（主链）上运行更高的吞吐量。同时，它将使交易成本最小化。第二层还可以帮助解决与隐私、交易机密性和数据保管相关的问题。此外，它还可以帮助企业避免在支付交易时处理加密货币令牌和价格波动。
Ethereum 允许我们构建Layer2扩容解决方案，以达到访问速度、最终性和开销成本之间的一个新的平衡点。这使得底层的区块链可以广泛用于更多的应用程序，不同类型的应用程序具有不同的威胁模型将有不同的权衡自然偏好。对于高价值的交易使用主链会更加安全，对于某些限定性交易可以使用状态通道或者支付通道，对于交易速度更重要的数字收藏品或者区块链游戏，我们可以使用Plasma或者Rollup等方案，未来也会有更多的Layer2解决方案。总的来说Layer2扩容就是作出一些权衡而不损害底层区块链，保持去中心化和最终性。
此外，我们还根据发现的缺点总结了一些潜在的研究方向和未解决的问题，例如需要压缩或修剪的大量区块链数据、时间成本较高的欺诈证明以及对EVM兼容性较差得ZK-Rollup，本文旨在通过这项全面的调查，希望我们的分类和对当前解决方案的分析能够激发致力于提高区块链可扩展性的进一步研究。




[1] J. Poon and V. Buterin, “Plasma: Scalable autonomous smart contracts,”White paper, pp. 1–47, 2017
[2] A. Back, M. Corallo, L. Dashjr, M. Friedenbach, G. Maxwell, A. Miller,A. Poelstra, J. Timón, and P. Wuille, “Enabling blockchain innovationswith pegged sidechains,” URL: http://www. opensciencereview.com/papers/123/enablingblockchain-innovations-with-pegged-sidechains, p. 72, 2014.
[3] J. Poon and V. Buterin, “Plasma: Scalable autonomous smart contracts,”White paper, pp. 1–47, 2017
[4] Kalodner, Harry, et al. "Arbitrum: Scalable, private smart contracts." 27th {USENIX} Security Symposium ({USENIX} Security 18). 2018.
[5] John Adler and Mikerah Quintyne-Collins. 2019. Building Scalable Decentralized Payment Systems. arXiv preprint arXiv:1904.06441 (2019)

